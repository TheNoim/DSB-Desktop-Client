<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DSB</title>
    <link rel="stylesheet" type="text/css" href="index.css">
    <link rel="stylesheet" type="text/css" href="components/angular-material/angular-material.min.css">
    <link rel="stylesheet" type="text/css" href="components/angular-animate-css/build/nga.all.min.css">
    <link rel="stylesheet" type="text/css" href="components/angular-material-data-table/dist/md-data-table.min.css">
    <link rel="stylesheet" type="text/css" href="components/material-design-icons/iconfont/material-icons.css">
    <style>
        html {
            background-color: #424242;
        }

        body {
            background-color: #424242;
        }
    </style>
    <script type="text/javascript" src="StorageEngine.js"></script>
</head>
<body ng-app="DSBApp" ng-controller="DSBController" md-theme="altTheme">
<div ng-cloak class="nga-default nga-fade" ng-show="loaded">
    <md-toolbar class="md-whiteframe-12dp">
        <div class="md-toolbar-tools">
            <span>DSB</span>
            <span flex></span>
            <md-button class="md-icon-button" ng-click="settings()">
                <md-icon>settings</md-icon>
            </md-button>
            <md-button class="md-icon-button" ng-disabled="loading" ng-click="bootstrap()">
                <md-icon>refresh</md-icon>
            </md-button>
        </div>
    </md-toolbar>
    <md-progress-linear class="nga-fade nga-fast nga-stagger-fast" md-mode="{{ ProgressMode }}" ng-if="ProgressBar"
                        value="{{ ProgressValue }}"
                        style="background-color: #FFEB3B !important; color: rgba(0,0,0,0) !important;"></md-progress-linear>
    <div ng-repeat="(PlanKey, PlanValue) in Plans" class="nga-fade nga-fast nga-stagger-fast">
        <md-toolbar flex style="width: 100%; background-color: #FFEB3B;">
            <div class="md-toolbar-tools">
                <span style="color: #000000;">{{ PlanValue.date }}</span>
                <span flex></span>
                <span style="color: #000000;">Stand: {{ PlanValue.lastUpdate }}</span>
            </div>
        </md-toolbar>
        <md-table-container flex>
            <table md-table>
                <thead md-head>
                <tr md-row>
                    <th md-column class="headercolor">Klassen</th>
                    <th md-column class="headercolor">Stunden</th>
                    <th md-column class="headercolor">Fach</th>
                    <th md-column class="headercolor">Lehrer</th>
                    <th md-column class="headercolor">Statt</th>
                    <th md-column class="headercolor">Raum</th>
                    <th md-column class="headercolor">Bemerkung</th>
                    <th md-column class="headercolor">Entfall</th>
                </tr>
                </thead>
                <tbody md-body ng-if="PlanValue.plan.length > 0">
                <tr md-row ng-repeat="(PKey, PValue) in PlanValue.plan">
                    <td md-cell>
                        <div ng-if="!PValue.GanzerJahrgang">
                            <no-fu ng-repeat="(KKey, KValue) in PValue.Klassen" class="cellcolor">{{ KValue }}<no-fu ng-if="$last == false">,</no-fu><br ng-if="($index % 4) === 0 && $first == false" hide-gt-sm></no-fu>
                        </div>
                        <div ng-if="PValue.GanzerJahrgang" class="cellcolor">{{ PValue['Klasse(n)'].toString() }}</div>
                    </td>
                    <td md-cell class="cellcolor">{{ PValue.Stunden.toString() }}</td>
                    <td md-cell class="cellcolor">{{ PValue.Fach }}</td>
                    <td md-cell class="cellcolor">{{ PValue.Lehrer }}</td>
                    <td md-cell class="cellcolor">{{ PValue.statt }}</td>
                    <td md-cell>
                        <div ng-if="PValue.Raum" class="cellcolor">{{ PValue.Raum }}</div>
                        <md-icon ng-if="PValue.Raum == null" style="color: #FFEB3B">warning</md-icon>
                    </td>
                    <td md-cell class="cellcolor">{{ PValue.Bemerkungen }}</td>
                    <td md-cell>
                        <md-icon ng-if="PValue.Entfall" style="color: #FFEB3B">done</md-icon>
                        <md-icon ng-if="!PValue.Entfall" class="cellcolor">close</md-icon>
                    </td>
                </tr>
                </tbody>
                <div ng-if="PlanValue.plan.length == 0 && klassen.length == 1" layout="row" layout-align="center center">
                    <p><i>Es ist nichts für deine Klasse eingetragen: {{ klassen[0] }}</i></p>
                </div>
                <div ng-if="PlanValue.plan.length == 0 && klassen.length > 1" layout="row" layout-align="center center">
                    <p><i>Es ist nichts für deine Klassen eingetragen: {{ klassen }}</i></p>
                </div>
            </table>
        </md-table-container>
    </div>
</div>
<script type="text/javascript" src="components/percentage-calc/dist/percentage-calc.min.js"></script>
<script type="text/javascript" src="date-de-DE.js"></script>
<script type="text/javascript" src="components/socket.io-client/dist/socket.io.min.js"></script>
<script type="text/javascript" src="components/angular/angular.min.js"></script>
<script type="text/javascript" src="components/angular-aria/angular-aria.min.js"></script>
<script type="text/javascript" src="components/angular-animate/angular-animate.min.js"></script>
<script type="text/javascript" src="components/angular-messages/angular-messages.min.js"></script>
<script type="text/javascript" src="components/angular-material/angular-material.min.js"></script>
<script type="text/javascript" src="components/angular-material-data-table/dist/md-data-table.min.js"></script>
<script type="text/javascript">
    // Electron stuff:
    const isDev = require('electron-is-dev');
    const {ipcRenderer} = require('electron');
    const {Socket} = require('electron-ipc-socket');
    const AutoLaunch = require('auto-launch');
    const socket = Socket('MainSocket', ipcRenderer);
    socket.open();

    if (isDev) {
        const debugMenu = require('debug-menu');
        debugMenu.install();
    }
    // Client
    const app = angular.module('DSBApp', ['ngMaterial', 'ngAnimate', 'md.data.table']);
    app.controller('DSBController', ($scope, $timeout, $rootScope, $mdToast, $mdDialog) => {
        $scope.safeApply = function (fn) {
            const phase = this.$root.$$phase;
            if (phase == '$apply' || phase == '$digest') {
                if (fn && (typeof(fn) === 'function')) {
                    fn();
                }
            } else {
                this.$apply(fn);
            }
        };
        $scope.loaded = false;
        $scope.loading = false;
        $scope.bootstrap = () => {
            $scope.checkDialog(() => {
                $scope.loading = true;
                $scope.ProgressBar = true;
                $scope.ProgressMode = "indeterminate";
                socket.send('SETUP_DSB', {
                    host: $scope.host,
                    username: $scope.username,
                    password: $scope.password,
                    path: $scope.path
                }, (error, payload) => {
                    if (payload.error){
                        $scope.loading = false;
                        $mdToast.showSimple(`Error: ${payload.error}`);
                    } else {
                        $scope.ProgressMode = "determinate";
                        $scope.safeApply(() => {
                            socket.send('QUERY_DSB', {}, (error, payload) => {
                                $scope.loading = false;
                                if (error) {
                                    console.error(error);
                                    return;
                                }
                                if (!payload.error){
                                    $scope.Plans = payload.Plans;
                                    $scope.ProgressValue = 100;
                                    $scope.ProgressBar = true;
                                    $scope.Plans.sort(function(a,b){
                                        console.log(Date.parse(b.date) - Date.parse(a.date));
                                        return Date.parse(b.date) - Date.parse(a.date);
                                    });
                                    for (let Index in $scope.Plans){
                                        if ($scope.Plans.hasOwnProperty(Index)){
                                            $scope.Plans[Index].date = Date.parse($scope.Plans[Index].date).toString('dd.MM.yy dddd');
                                            $scope.Plans[Index].lastUpdate = Date.parse($scope.Plans[Index].lastUpdate).toString('dd.MM HH:mm');
                                        }
                                    }
                                    $scope.PlanC = JSON.parse(JSON.stringify($scope.Plans));
                                    $scope.applyFilter();
                                    $scope.safeApply(function () {
                                        console.log(payload);
                                    });
                                } else {
                                    $mdToast.showSimple(`Error: ${payload.error}`);
                                }
                            });
                        });
                    }
                });
            });
        };
        socket.on('event:DSB_PROGRESS', (DATA) => {
            console.log("[Client] Progress...", DATA);
            $scope.ProgressValue = percentage.from(DATA.PROGRESS, DATA.MAX);
            $scope.safeApply();
        });
        $scope.applyFilter = function () {
            $scope.Plans = JSON.parse(JSON.stringify($scope.PlanC));
            let klassen = [];
            for (let Index in $scope.jahrgaengefilter) {
                if ($scope.jahrgaengefilter.hasOwnProperty(Index)) {
                    const Stufe = $scope.jahrgaengefilter[Index];
                    for (let BIndex in $scope.klassenfilter) {
                        if ($scope.klassenfilter.hasOwnProperty(BIndex)) {
                            const Buchstabe = $scope.klassenfilter[BIndex];
                            klassen.push(`${Stufe}${Buchstabe}`);
                        }
                    }
                }
            }
            $scope.klassen = JSON.parse(JSON.stringify(klassen));
            if (klassen.length == 0) {
                $scope.Plans = $scope.PlanC;
                console.log("No filter");
                return;
            }
            for (Index in $scope.Plans) {
                if (!$scope.Plans.hasOwnProperty(Index)) continue;
                let CopyPlan = $scope.Plans[Index].plan;
                $scope.Plans[Index].plan = [];
                for (PlanIndex in CopyPlan) {
                    if (!CopyPlan.hasOwnProperty(PlanIndex)) continue;
                    for (KlassenIndex in klassen) {
                        if (!klassen.hasOwnProperty(KlassenIndex)) continue;
                        if (CopyPlan[PlanIndex].Klassen.indexOf(klassen[KlassenIndex].toUpperCase()) != -1) {
                            $scope.Plans[Index].plan.push(CopyPlan[PlanIndex]);
                            break;
                        }
                    }
                }
            }
        };
        $scope.settings = function (callback) {
            $mdDialog.show({
                templateUrl: 'SettingsDialog.html',
                scope: $scope,
                preserveScope: true,
                hasBackdrop: true,
                fullscreen: true,
                controller: ($scope, $mdDialog) => {
                    // BACKUP OF VALUES
                    const jb = copy($scope.jahrgaengefilter);
                    const kb = copy($scope.klassenfilter);
                    const ab = copy($scope.autoStart);
                    $scope.save = function () {
                        saveValue('jahrgaengefilter', $scope.jahrgaengefilter, () => {
                            saveValue('klassenfilter', $scope.klassenfilter, () => {
                                saveValue('autoStart', $scope.autoStart, () => {
                                    saveValue('host', $scope.host, () => {
                                        saveValue('password', $scope.password, () => {
                                            saveValue('username', $scope.username, () => {
                                                saveValue('path', $scope.path, () => {
                                                    saveValue('hideAutoStart', $scope.hideAutoStart, () => {
                                                        if ($scope.Plans){
                                                            $scope.applyFilter();
                                                        }
                                                        $scope.safeApply();
                                                        $mdDialog.hide();
                                                        $scope.applyAutoStart();
                                                        socket.send('DELETE_COOKIES');
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    };
                    $scope.cancel = function () {
                        // Restore original
                        $scope.jahrgaengefilter = copy(jb);
                        $scope.klassenfilter = copy(kb);
                        $scope.autoStart = copy(ab);
                        $mdDialog.hide();
                    };
                },
                onRemoving: () => {
                    if (callback){
                        callback();
                    }
                }
            });
        };
        $scope.checkDialog = (callback) => {
            if (!$scope.host || !$scope.username || !$scope.password){
                $scope.settings(() => {
                    $scope.checkDialog(() => {
                        callback();
                    });
                });
            } else {
                callback();
            }
        };
        $scope.dsbSetUpPrepare = (Callback) => {
            getValue('host', (error, host) => {
                $scope.host = host ? host : null;
                getValue('username', (error, username) => {
                    $scope.username = username ? username : null;
                    getValue('password', (error, password) => {
                        $scope.password = password ? password : null;
                        getValue('path', (error, path) => {
                            $scope.path = path ? path : null;
                            $scope.checkDialog(Callback);
                        });
                    });
                });
            });
        };
        $scope.applyAutoStart = () => {
            if (!$scope.AutoLaunchApp){
                $scope.AutoLaunchApp = new AutoLaunch({
                    name: "DSB Client",
                    isHidden: $scope.hideAutoStart
                });
            }
            if ($scope.autoStart){
                if ($scope.autoStart == true) $mdToast.showSimple(`Auto start enabled.`);
                $scope.AutoLaunchApp.enable();
            } else {
                if ($scope.autoStart == false) $mdToast.showSimple(`Auto start disabled.`);
                $scope.AutoLaunchApp.disable();
            }
        };
        $timeout(() => {
            getValue('jahrgaengefilter', (error, jahrgaengefilter) => {
                $scope.jahrgaengefilter = jahrgaengefilter ? jahrgaengefilter : [];
                getValue('klassenfilter', (error, klassenfilter) => {
                    $scope.klassenfilter = klassenfilter ? klassenfilter : [];
                    getValue('autoStart', (error, autoStart) => {
                        $scope.autoStart = autoStart ? autoStart : false;
                        getValue('hideAutoStart', (error, hideAutoStart) => {
                            $scope.hideAutoStart = hideAutoStart ? hideAutoStart : false;
                            $scope.dsbSetUpPrepare(() => {
                                $scope.loaded = true;
                                $scope.applyAutoStart();
                                $scope.safeApply(() => {
                                    $scope.bootstrap();
                                });
                            });
                        });
                    });
                });
            });
        }, 100);
    });
    app.config(function ($mdThemingProvider) {
        $mdThemingProvider.theme('altTheme')
            .primaryPalette('grey', {
                'default': '900'
            })
            .accentPalette('grey', {
                'default': '700'
            })
            .dark();
        $mdThemingProvider.theme('default')
            .dark();
        $mdThemingProvider.setDefaultTheme('altTheme');
        $mdThemingProvider.alwaysWatchTheme(true);
        $mdThemingProvider.theme('docs-dark', 'default')
            .primaryPalette('yellow')
            .dark();
    });

    function copy(what) {
        return JSON.parse(JSON.stringify(what))
    }
</script>
</body>
</html>